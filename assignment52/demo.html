<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlexiForms â€” Form Builder (Supabase)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #121827;
      --muted: #a3adc2;
      --text: #e6e9f2;
      --accent: #6ee7ff; /* change in UI */
      --danger: #ff6b6b;
      --ok: #22c55e;
      --warn: #f59e0b;
      --card: #0f1422;
      --border: #1f2937;
      --input: #0b1220;
    }
    *{ box-sizing: border-box }
    body{
      margin:0; background: radial-gradient(1200px 800px at 20% -10%, rgba(110,231,255,.12), transparent 60%),
      radial-gradient(800px 600px at 110% 20%, rgba(168,85,247,.10), transparent 50%), var(--bg);
      color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100dvh; display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(140%) blur(10px);
      background: linear-gradient(180deg, rgba(11,15,25,.9), rgba(11,15,25,.6));
      border-bottom:1px solid var(--border);
    }
    .bar{ max-width:1200px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; gap:14px; }
    .logo{ font-weight:800; letter-spacing:.4px; }
    .badge{ font-size:12px; color:#0b1220; background:var(--accent); padding:2px 8px; border-radius:999px; font-weight:700 }
    .grow{ flex:1 }
    .row{ display:flex; gap:12px; align-items:center }
    .btn{ background:linear-gradient(180deg, #1a2437, #121a2b); color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.15s transform ease, .15s background ease; }
    .btn:hover{ transform:translateY(-1px); }
    .btn.primary{ background: linear-gradient(180deg, #1f3a4d, #112b3a); border-color:#264b63; box-shadow: 0 0 0 1px rgba(110,231,255,.15) inset; }
    .btn.ok{ background: linear-gradient(180deg, rgba(34,197,94,.15), rgba(34,197,94,.05)); border-color: rgba(34,197,94,.35);}    
    .btn.danger{ background: linear-gradient(180deg, rgba(255,107,107,.15), rgba(255,107,107,.05)); border-color: rgba(255,107,107,.35);}    
    .btn.small{ padding:6px 10px; border-radius:10px; font-size:12px }
    .btn.flat{ background:transparent; border-color:transparent; }
    .pill{ padding:8px 12px; border-radius:999px; background:#0b1220; border:1px solid var(--border); font-size:12px; color:var(--muted) }

    main{ max-width:1200px; margin:18px auto; padding:0 20px 40px; width:100% }
    .panel{ background: linear-gradient(180deg, rgba(17,24,39,.8), rgba(12,18,30,.8)); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .grid{ display:grid; grid-template-columns: 280px 1fr; gap:16px }

    .field-types{ background:var(--panel); border:1px dashed #233146; border-radius:16px; padding:10px; }
    .field-types h4{ margin:6px 8px 12px; font-size:13px; color:var(--muted); font-weight:700; letter-spacing:.3px }
    .type-btn{ display:block; width:100%; text-align:left; background:var(--card); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:12px; margin:6px 0; cursor:pointer }

    .canvas{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .meta{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px }
    .meta .col{ background:var(--card); border:1px solid var(--border); padding:12px; border-radius:14px }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="number"], input[type="email"], textarea, select{
      width:100%; background:var(--input); border:1px solid var(--border); padding:10px 12px; border-radius:12px; color:var(--text); outline:none; font-size:14px;
    }
    textarea{ min-height:80px; }
    .switch{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted) }

    .field-card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; margin:10px 0; position:relative }
    .field-title{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px }
    .field-actions{ display:flex; gap:6px }
    .chip{ font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#0b1220; color:var(--muted) }

    .preview{ border-top:1px dashed #2b3954; margin-top:14px; padding-top:14px }

    .hl{ color:var(--accent) }
    .muted{ color:var(--muted) }
    .center{ text-align:center }
    .mt8{ margin-top:8px }
    .mt12{ margin-top:12px }
    .mt16{ margin-top:16px }
    .mt20{ margin-top:20px }

    .toast{ position:fixed; right:18px; bottom:18px; background:#0b1220; border:1px solid var(--border); padding:12px 14px; border-radius:14px; box-shadow:0 6px 30px rgba(0,0,0,.35); display:none }

    .notice{ background: rgba(110,231,255,.08); border:1px solid rgba(110,231,255,.25); padding:10px 12px; border-radius:12px; font-size:13px; color:#cbefff }

    .divider{ height:1px; background: var(--border); margin:10px 0 }

    .accent-swatch{ width:24px; height:24px; border-radius:8px; border:1px solid var(--border) }

    /* Fill mode */
    .form-shell{ max-width:760px; margin: 18px auto; background:linear-gradient(180deg,#121a2b,#0c1422); border:1px solid var(--border); border-radius:18px; overflow:hidden }
    .form-head{ padding:20px; border-bottom:1px solid var(--border); background:linear-gradient(90deg, rgba(110,231,255,.18), transparent); }
    .form-body{ padding:18px }
    .req{ color: var(--warn); margin-left:4px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">âš¡ Flexi<span class="hl">Forms</span></div>
      <span class="badge">HTML + JS + Supabase</span>
      <div class="grow"></div>
      <div id="headerActions" class="row"></div>
    </div>
  </header>

  <main>
    <div id="modeBuild" style="display:none">
      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div style="font-size:20px; font-weight:800">Form Builder <span class="hl">(MVP)</span></div>
            <div class="muted">Banaye, preview karein aur publish link share karein.</div>
          </div>
          <div class="row">
            <button class="btn" id="btnPreviewToggle">Preview</button>
            <button class="btn primary" id="btnPublish">Publish</button>
          </div>
        </div>
      </div>

      <div class="grid mt16">
        <aside class="field-types">
          <h4>Field Types</h4>
          <button class="type-btn" data-type="short_text">Short Text</button>
          <button class="type-btn" data-type="long_text">Long Text</button>
          <button class="type-btn" data-type="email">Email</button>
          <button class="type-btn" data-type="number">Number</button>
          <button class="type-btn" data-type="radio">Multiple Choice</button>
          <button class="type-btn" data-type="checkbox">Checkboxes</button>
          <button class="type-btn" data-type="select">Dropdown</button>
          <button class="type-btn" data-type="date">Date</button>
          <button class="type-btn" data-type="time">Time</button>
          <button class="type-btn" data-type="file">File Upload</button>
          <div class="divider"></div>
          <button class="type-btn" data-type="section">Section Heading</button>
          <button class="type-btn" data-type="description">Description Text</button>
        </aside>

        <section class="canvas">
          <div class="meta">
            <div class="col">
              <label>Form Title</label>
              <input type="text" id="formTitle" placeholder="e.g., Event Registration" />
              <div class="mt8">
                <label>Description</label>
                <textarea id="formDesc" placeholder="Tell respondents what this form is about..."></textarea>
              </div>
            </div>
            <div class="col">
              <label class="row" style="justify-content:space-between; align-items:center">Theme Accent <span class="accent-swatch" id="accentSwatch"></span></label>
              <input type="text" id="accentColor" value="#6ee7ff" />
              <div class="mt8 notice">Unique touch: aap apni accent color set kar sakte hain â€” Google Forms se different visual identity.</div>
            </div>
          </div>

          <div id="fieldsRoot"></div>

          <div class="row mt12">
            <button class="btn" id="btnClear">Clear All</button>
            <div class="grow"></div>
            <button class="btn" id="btnSaveDraft">Save Draft (Local)</button>
          </div>

          <div class="preview" id="builderPreview" style="display:none"></div>
        </section>
      </div>
    </div>

    <div id="modeFill" style="display:none">
      <div class="form-shell">
        <div class="form-head">
          <div style="font-size:22px; font-weight:800" id="fillTitle"></div>
          <div class="muted" id="fillDesc"></div>
        </div>
        <form class="form-body" id="fillForm"></form>
      </div>
    </div>

    <div id="modeThanks" style="display:none" class="center">
      <div class="panel" style="max-width:560px; margin:40px auto;">
        <div style="font-size:22px; font-weight:800">Shukriya! ðŸŽ‰</div>
        <div class="muted mt8">Aapka response record ho gaya hai.</div>
        <div class="row mt16 center" style="justify-content:center">
          <a class="btn" id="btnAnother" href="#">Submit another response</a>
        </div>
      </div>
    </div>

  </main>

  <div class="toast" id="toast"></div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ===================== CONFIG ===================== */
    const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co"; // TODO: replace
    const SUPABASE_ANON = "YOUR-ANON-KEY"; // TODO: replace
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ===================== UTILITIES ===================== */
    const $ = sel => document.querySelector(sel);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
    const uid = () => "id-" + Math.random().toString(36).slice(2,10);
    const slugify = (s) => s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,48) + '-' + Math.random().toString(36).slice(2,6);
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2400); };

    /* ===================== STATE ===================== */
    const state = {
      mode: 'build', // or 'fill'
      form: { title: '', description: '', accent: '#6ee7ff' },
      fields: [], // array of {id,type,label,help,required,options:[],order}
      publishedSlug: null,
      fill: { form_id: null, slug: null }
    };

    const fieldPresets = {
      short_text: { label: 'Short answer', help: '', required: false },
      long_text:  { label: 'Paragraph', help: '', required: false },
      email:      { label: 'Email address', help: '', required: true },
      number:     { label: 'Number', help: '', required: false },
      radio:      { label: 'Choose one', help: '', required: false, options:['Option 1','Option 2'] },
      checkbox:   { label: 'Select options', help: '', required: false, options:['Option A','Option B'] },
      select:     { label: 'Dropdown', help: '', required: false, options:['Item 1','Item 2','Item 3'] },
      date:       { label: 'Date', help: '', required: false },
      time:       { label: 'Time', help: '', required: false },
      file:       { label: 'Upload file', help: 'e.g., image or PDF', required: false },
      section:    { label: 'Section Title', help: '', required: false },
      description:{ label: 'Description', help: 'Explain something to the user', required: false },
    };

    /* ===================== MODE SWITCH ===================== */
    function init(){
      const params = new URLSearchParams(location.search);
      if(params.has('f')){ state.mode = 'fill'; state.fill.slug = params.get('f'); }
      renderHeader();
      if(state.mode==='fill'){ renderFillMode(); } else { renderBuildMode(); }
    }

    function renderHeader(){
      const actions = $('#headerActions');
      actions.innerHTML = '';
      if(state.mode==='fill'){
        const backBtn = el('a', { className:'btn small flat', href: location.pathname, textContent: 'Create your form' });
        actions.appendChild(backBtn);
      } else {
        const link = el('span', { className:'pill', textContent: 'Accent:' });
        const sw = el('span', { className:'accent-swatch' }); sw.style.background = state.form.accent;
        const edit = el('input', { type:'color', value: state.form.accent });
        edit.addEventListener('input', e=>{ state.form.accent = e.target.value; document.documentElement.style.setProperty('--accent', state.form.accent); $('#accentSwatch').style.background = state.form.accent; });
        actions.append(link, sw, edit);
      }
    }

    /* ===================== BUILD MODE ===================== */
    function renderBuildMode(){
      $('#modeFill').style.display='none';
      $('#modeThanks').style.display='none';
      $('#modeBuild').style.display='block';
      $('#accentSwatch').style.background = state.form.accent;
      $('#accentColor').value = state.form.accent;

      $('#formTitle').value = state.form.title;
      $('#formDesc').value = state.form.description;

      // bind inputs
      $('#formTitle').oninput = e=> state.form.title = e.target.value;
      $('#formDesc').oninput = e=> state.form.description = e.target.value;
      $('#accentColor').oninput = e=> { state.form.accent = e.target.value; document.documentElement.style.setProperty('--accent', state.form.accent); $('#accentSwatch').style.background = state.form.accent; };

      // field buttons
      document.querySelectorAll('.type-btn').forEach(btn=>{
        btn.onclick = ()=> addField(btn.dataset.type);
      });

      $('#btnClear').onclick = ()=>{ if(confirm('Clear all fields?')){ state.fields=[]; paintFields(); saveDraftLocal(); }}
      $('#btnSaveDraft').onclick = ()=>{ saveDraftLocal(); toast('Draft saved locally'); }
      $('#btnPreviewToggle').onclick = ()=> togglePreview();
      $('#btnPublish').onclick = ()=> publishForm();

      paintFields();
    }

    function addField(type){
      const preset = fieldPresets[type];
      const base = { id: uid(), type, label: preset.label, help: preset.help||'', required: preset.required||false, options: preset.options? [...preset.options] : [], order: state.fields.length };
      state.fields.push(base); paintFields(); saveDraftLocal();
    }

    function moveField(i, dir){
      const j = i + dir; if(j<0 || j>=state.fields.length) return; [state.fields[i], state.fields[j]] = [state.fields[j], state.fields[i]]; state.fields.forEach((f,idx)=>f.order=idx); paintFields(); saveDraftLocal();
    }

    function deleteField(i){ if(confirm('Delete this field?')){ state.fields.splice(i,1); state.fields.forEach((f,idx)=>f.order=idx); paintFields(); saveDraftLocal(); } }

    function paintFields(){
      const root = $('#fieldsRoot'); root.innerHTML='';
      if(state.fields.length===0){
        const empty = el('div', { className:'notice', innerHTML:'Start by adding fields from the left. Yeh UI minimal aur unique rahega â€” no Google Form copy.'});
        root.appendChild(empty); return;
      }
      state.fields.forEach((f, i)=>{
        const card = el('div', { className:'field-card' });
        const head = el('div', { className:'field-title' });
        head.appendChild(el('div', { innerHTML: `<span class="chip">${f.type}</span>` }));
        const actions = el('div', { className:'field-actions' });
        actions.append(
          el('button', { className:'btn small', textContent:'Up', onclick:()=>moveField(i,-1) }),
          el('button', { className:'btn small', textContent:'Down', onclick:()=>moveField(i,1) }),
          el('button', { className:'btn small danger', textContent:'Delete', onclick:()=>deleteField(i) }),
        );
        head.appendChild(actions);
        card.appendChild(head);

        // editable props
        const label = el('div');
        label.appendChild(el('label', { textContent:'Label' }));
        const labelInput = el('input', { type:'text', value:f.label });
        labelInput.oninput = e=>{ f.label = e.target.value; saveDraftLocal(); };
        label.appendChild(labelInput);
        card.appendChild(label);

        const help = el('div', { className:'mt8' });
        help.appendChild(el('label', { textContent:'Help text (optional)' }));
        const helpInput = el('input', { type:'text', value:f.help });
        helpInput.oninput = e=>{ f.help = e.target.value; saveDraftLocal(); };
        help.appendChild(helpInput);
        card.appendChild(help);

        if(['radio','checkbox','select'].includes(f.type)){
          const opt = el('div', { className:'mt8' });
          opt.appendChild(el('label', { textContent:'Options (one per line)' }));
          const ta = el('textarea', { value: f.options.join('\n') });
          ta.oninput = e=>{ f.options = e.target.value.split(/\n+/).filter(Boolean); saveDraftLocal(); };
          opt.appendChild(ta);
          card.appendChild(opt);
        }

        const tail = el('div', { className:'row mt8' });
        const req = el('label', { className:'switch' });
        const reqIn = el('input', { type:'checkbox', checked:f.required });
        reqIn.onchange = e=>{ f.required = e.target.checked; saveDraftLocal(); };
        req.append(reqIn, el('span', { textContent:'Required' }));
        tail.appendChild(req);
        card.appendChild(tail);

        root.appendChild(card);
      });
    }

    function togglePreview(){
      const wrap = $('#builderPreview');
      if(wrap.style.display==='none'){ wrap.style.display='block'; wrap.innerHTML = ''; wrap.appendChild(renderPreview()); }
      else { wrap.style.display='none'; wrap.innerHTML = ''; }
    }

    function renderPreview(){
      const form = el('div', { className:'form-shell' });
      const head = el('div', { className:'form-head' });
      head.appendChild(el('div', { style:'font-size:20px; font-weight:800', textContent: state.form.title || 'Untitled form' }));
      head.appendChild(el('div', { className:'muted', textContent: state.form.description||'' }));
      form.appendChild(head);
      const body = el('div', { className:'form-body' });
      state.fields.forEach(f=> body.appendChild(renderFieldPreview(f)) );
      form.appendChild(body);
      return form;
    }

    function renderFieldPreview(f){
      const wrap = el('div', { className:'mt12' });
      const lbl = el('div', { innerHTML:`<strong>${f.label}</strong> ${f.required?'<span class="req">*</span>':''}` });
      const help = el('div', { className:'muted', textContent: f.help });
      wrap.append(lbl, help);
      const inputWrap = el('div', { className:'mt8' });
      switch(f.type){
        case 'short_text': inputWrap.appendChild(el('input', { type:'text', placeholder:'Your answer' })); break;
        case 'long_text': inputWrap.appendChild(el('textarea', { placeholder:'Your answer' })); break;
        case 'email': inputWrap.appendChild(el('input', { type:'email', placeholder:'name@example.com' })); break;
        case 'number': inputWrap.appendChild(el('input', { type:'number', placeholder:'123' })); break;
        case 'radio': f.options.forEach(opt=>{
          const r= el('div', { className:'row', style:'gap:8px; align-items:center' });
          r.appendChild(el('input', { type:'radio', name:f.id })); r.appendChild(el('span', { textContent:opt })); inputWrap.appendChild(r);
        }); break;
        case 'checkbox': f.options.forEach(opt=>{
          const r= el('div', { className:'row', style:'gap:8px; align-items:center' });
          r.appendChild(el('input', { type:'checkbox', name:f.id })); r.appendChild(el('span', { textContent:opt })); inputWrap.appendChild(r);
        }); break;
        case 'select': const sel = el('select'); f.options.forEach(opt=> sel.appendChild(el('option', { value:opt, textContent:opt })) ); inputWrap.appendChild(sel); break;
        case 'date': inputWrap.appendChild(el('input', { type:'date' })); break;
        case 'time': inputWrap.appendChild(el('input', { type:'time' })); break;
        case 'file': inputWrap.appendChild(el('input', { type:'file' })); break;
        case 'section': const s = el('div', { style:'font-weight:800; font-size:18px; color:var(--accent)', textContent:f.label }); inputWrap.appendChild(s); break;
        case 'description': inputWrap.appendChild(el('div', { className:'muted', textContent:f.help || f.label })); break;
      }
      wrap.appendChild(inputWrap);
      return wrap;
    }

    function saveDraftLocal(){
      const payload = { form: state.form, fields: state.fields };
      localStorage.setItem('flexiforms_draft', JSON.stringify(payload));
    }

    function loadDraftLocal(){
      try{ const raw = localStorage.getItem('flexiforms_draft'); if(!raw) return; const obj = JSON.parse(raw); state.form = obj.form || state.form; state.fields = obj.fields || []; }
      catch(e){}
    }

    async function publishForm(){
      if(!state.form.title){ toast('Title required'); return; }
      if(state.fields.length===0){ toast('Add at least one field'); return; }

      const slug = slugify(state.form.title);

      // 1) Create form
      const { data:formRow, error:formErr } = await sb.from('forms').insert({
        title: state.form.title,
        description: state.form.description,
        accent: state.form.accent,
        is_published: true,
        slug
      }).select('*').single();
      if(formErr){ console.error(formErr); toast('Failed to publish form'); return; }

      // 2) Insert fields
      const toInsert = state.fields.map((f,idx)=>({
        form_id: formRow.id,
        type: f.type,
        label: f.label,
        help: f.help,
        required: f.required,
        order_index: idx,
        options: (f.options||[])
      }));
      const { error:fieldsErr } = await sb.from('fields').insert(toInsert);
      if(fieldsErr){ console.error(fieldsErr); toast('Form created but fields failed'); return; }

      state.publishedSlug = slug;
      const share = `${location.origin}${location.pathname}?f=${slug}`;
      navigator.clipboard && navigator.clipboard.writeText(share).catch(()=>{});
      toast('Published! Link copied to clipboard');

      // show a small panel
      const wrap = $('#builderPreview');
      wrap.style.display='block';
      wrap.innerHTML = `<div class="notice">Share link: <a style="color:var(--accent)" href="${share}">${share}</a><br/>Open in new tab to test the live form.</div>`;
    }

    /* ===================== FILL MODE ===================== */
    async function renderFillMode(){
      $('#modeBuild').style.display='none';
      $('#modeThanks').style.display='none';
      $('#modeFill').style.display='block';

      const slug = state.fill.slug;
      const { data:form, error:fErr } = await sb.from('forms').select('*').eq('slug', slug).eq('is_published', true).single();
      if(fErr || !form){
        $('#fillTitle').textContent = 'Form not found';
        $('#fillDesc').textContent = 'Link sahi nahi hai ya form unpublished hai.';
        return;
      }
      state.fill.form_id = form.id;
      document.documentElement.style.setProperty('--accent', form.accent||'#6ee7ff');
      $('#fillTitle').textContent = form.title;
      $('#fillDesc').textContent = form.description||'';

      const { data:fields, error:e2 } = await sb.from('fields').select('*').eq('form_id', form.id).order('order_index');
      if(e2){ $('#fillDesc').textContent = 'Fields load nahi huay.'; return; }

      const frm = $('#fillForm'); frm.innerHTML='';
      fields.forEach(f=> frm.appendChild(renderFillField(f)) );
      const submit = el('button', { className:'btn ok mt16', type:'submit', textContent:'Submit' });
      frm.appendChild(submit);

      frm.onsubmit = (ev)=> handleSubmit(ev, fields);
    }

    function renderFillField(f){
      const wrap = el('div', { className:'mt12' });
      if(f.type!=='description'){
        const lbl = el('label', { innerHTML:`<strong>${f.label}</strong> ${f.required?'<span class="req">*</span>':''}` }); wrap.appendChild(lbl);
        if(f.help) wrap.appendChild(el('div', { className:'muted', textContent:f.help }));
      }
      const iwrap = el('div', { className:'mt8' });
      switch(f.type){
        case 'short_text': iwrap.appendChild(el('input', { name:f.id, type:'text', required:f.required })); break;
        case 'long_text': iwrap.appendChild(el('textarea', { name:f.id, required:f.required })); break;
        case 'email': iwrap.appendChild(el('input', { name:f.id, type:'email', required:f.required })); break;
        case 'number': iwrap.appendChild(el('input', { name:f.id, type:'number', required:f.required })); break;
        case 'radio': f.options.forEach(opt=>{ const r= el('div', { className:'row', style:'gap:8px; align-items:center' }); r.appendChild(el('input', { type:'radio', name:f.id, value:opt, required:f.required })); r.appendChild(el('span', { textContent:opt })); iwrap.appendChild(r); }); break;
        case 'checkbox': f.options.forEach(opt=>{ const r= el('div', { className:'row', style:'gap:8px; align-items:center' }); r.appendChild(el('input', { type:'checkbox', name:f.id, value:opt })); r.appendChild(el('span', { textContent:opt })); iwrap.appendChild(r); }); break;
        case 'select': const sel = el('select', { name:f.id, required:f.required }); sel.appendChild(el('option', { value:'', textContent:'Select...' })); f.options.forEach(opt=> sel.appendChild(el('option', { value:opt, textContent:opt })) ); iwrap.appendChild(sel); break;
        case 'date': iwrap.appendChild(el('input', { name:f.id, type:'date', required:f.required })); break;
        case 'time': iwrap.appendChild(el('input', { name:f.id, type:'time', required:f.required })); break;
        case 'file': iwrap.appendChild(el('input', { name:f.id, type:'file', multiple:false, required:f.required })); break;
        case 'section': iwrap.appendChild(el('div', { style:'font-weight:800; font-size:18px; color:var(--accent)', textContent:f.label })); break;
        case 'description': iwrap.appendChild(el('div', { className:'muted', textContent:f.help || f.label })); break;
      }
      wrap.appendChild(iwrap);
      return wrap;
    }

    async function handleSubmit(ev, fields){
      ev.preventDefault();
      const fd = new FormData(ev.target);

      // 1) Create a response row
      const { data:resp, error:re } = await sb.from('responses').insert({ form_id: state.fill.form_id }).select('*').single();
      if(re){ console.error(re); toast('Submit failed'); return; }

      // 2) Build answers payload
      const answers = [];
      for(const f of fields){
        if(['section','description'].includes(f.type)) continue; // no input
        let value = null;
        if(f.type==='checkbox'){
          const boxes = [...document.querySelectorAll(`input[type=checkbox][name="${f.id}"]:checked`)];
          value = boxes.map(b=>b.value);
        } else if(f.type==='file'){
          const input = document.querySelector(`input[type=file][name="${f.id}"]`);
          if(input && input.files && input.files[0]){
            const file = input.files[0];
            const path = `form-files/${state.fill.slug}/${resp.id}/${f.id}-${Date.now()}-${file.name}`;
            const { error:upErr } = await sb.storage.from('form-files').upload(path, file);
            if(upErr){ console.error(upErr); toast('File upload failed (but other answers saved)'); }
            value = { path };
          }
        } else if(f.type==='radio'){
          const sel = document.querySelector(`input[type=radio][name="${f.id}"]:checked`); value = sel? sel.value : null;
        } else if(f.type==='select' || f.type==='date' || f.type==='time' || f.type==='email' || f.type==='number' || f.type==='short_text' || f.type==='long_text'){
          value = fd.get(f.id);
        }
        if(value===null || value==='' || (Array.isArray(value)&&value.length===0)){
          if(f.required){ toast('Please fill required fields'); return; }
          continue;
        }
        answers.push({ response_id: resp.id, field_id: f.id, value });
      }

      if(answers.length){
        const { error:aerr } = await sb.from('answers').insert(answers);
        if(aerr){ console.error(aerr); toast('Saved partially (answers error)'); return; }
      }

      $('#modeFill').style.display='none';
      $('#modeThanks').style.display='block';
      $('#btnAnother').href = location.href;
    }

    // boot
    loadDraftLocal();
    init();
  </script>

  <!-- =====================
  SUPABASE DATABASE SETUP (run this in SQL editor)

  -- Tables
  create table public.forms (
    id uuid primary key default gen_random_uuid(),
    title text not null,
    description text,
    accent text default '#6ee7ff',
    is_published boolean not null default false,
    slug text unique not null,
    owner_id uuid references auth.users(id),
    created_at timestamptz default now()
  );

  create table public.fields (
    id uuid primary key default gen_random_uuid(),
    form_id uuid not null references public.forms(id) on delete cascade,
    type text not null,
    label text not null,
    help text,
    required boolean default false,
    order_index int default 0,
    options jsonb default '[]'
  );

  create table public.responses (
    id uuid primary key default gen_random_uuid(),
    form_id uuid not null references public.forms(id) on delete cascade,
    submitted_at timestamptz default now()
  );

  create table public.answers (
    id uuid primary key default gen_random_uuid(),
    response_id uuid not null references public.responses(id) on delete cascade,
    field_id uuid not null,
    value jsonb
  );

  -- Row Level Security
  alter table public.forms enable row level security;
  alter table public.fields enable row level security;
  alter table public.responses enable row level security;
  alter table public.answers enable row level security;

  -- Policies: anyone can read published forms and their fields
  create policy "select_published_forms" on public.forms
    for select to anon, authenticated using (is_published = true);
  create policy "select_own_forms" on public.forms
    for select to authenticated using (auth.uid() = owner_id);

  create policy "select_fields_for_published" on public.fields
    for select to anon, authenticated using (
      exists (select 1 from public.forms f where f.id = form_id and f.is_published = true)
    );
  create policy "select_fields_for_owner" on public.fields
    for select to authenticated using (
      exists (select 1 from public.forms f where f.id = form_id and f.owner_id = auth.uid())
    );

  -- Simple publish flow from this app: allow anyone to INSERT a published form (ownerless)
  create policy "insert_published_form_ownerless" on public.forms
    for insert to anon, authenticated with check (is_published = true and owner_id is null);

  create policy "insert_fields_for_ownerless_forms" on public.fields
    for insert to anon, authenticated using (
      exists (select 1 from public.forms f where f.id = form_id and f.owner_id is null)
    ) with check (true);

  -- Responses: anyone can submit to published forms
  create policy "insert_response_for_published" on public.responses
    for insert to anon, authenticated with check (
      exists (select 1 from public.forms f where f.id = form_id and f.is_published = true)
    );
  -- Only owner can read responses (optional; ownerless forms responses won't be readable)
  create policy "select_responses_for_owner" on public.responses
    for select to authenticated using (
      exists (select 1 from public.forms f where f.id = form_id and f.owner_id = auth.uid())
    );

  -- Answers: insert allowed if response exists
  create policy "insert_answers" on public.answers
    for insert to anon, authenticated with check (
      exists (select 1 from public.responses r where r.id = response_id)
    );
  -- Only owner can read answers
  create policy "select_answers_for_owner" on public.answers
    for select to authenticated using (
      exists (
        select 1 from public.responses r
        join public.forms f on f.id = r.form_id
        where r.id = response_id and f.owner_id = auth.uid()
      )
    );

  -- Storage bucket for file uploads
  select storage.create_bucket('form-files', public := true);
  -- Allow anyone to upload to this bucket (for assignment/demo). Consider tightening later.
  create policy "upload_form_files" on storage.objects for insert to anon, authenticated
    with check ( bucket_id = 'form-files' );
  create policy "read_form_files" on storage.objects for select to anon, authenticated
    using ( bucket_id = 'form-files' );

  ===================== -->
</body>
</html>
